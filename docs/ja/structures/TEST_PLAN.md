# 構造体システム: テスト計画

このドキュメントでは、構造体 JSON システムの包括的なテスト戦略について説明します。目標は、構造の整合性、パースの正確性、および堅牢なエラーハンドリングを保証することです。

## 1. テスト戦略 (7つのフェーズ)

### フェーズ 1: JSON 統合 (45テスト)
- **基本ロード**: `name`, `displayName`, `recipeGroup` および基本的なメタデータの検証。
- **レイヤーパース**: 複数レイヤー、新旧フォーマット、空の行の取り扱い。
- **マッピングパース**: 単一/複数ブロックの関連付け、ワイルドカード、予約記号。
- **要件 (Requirement) パース**: 全7種のリソースタイプ、min/max 値、レジストリ統合。
- **エラーハンドリング**: 必須フィールドの欠落、構文エラー、無効な型の検出。

### フェーズ 2: 構造バリデーション (40テスト)
- **レイヤーの一貫性**: 行幅の不一致、空レイヤー、サイズ制限 (1x1x1 から 50x50x50)。
- **シンボルの整合性**: レイヤー内の未定義シンボル、マッピング内の未使用シンボル、コントローラー (Q) の存在確認。
- **コントローラー検出**: 正確なオフセット計算と回転 (180°) 処理。
- **ブロック解決**: 有効/無効な ID および Mod 固有のブロック処理。

### フェーズ 3: Builder パターン (25テスト)
- **操作**: Null 安全性、必須フィールドの検証、流れるような API の挙動。
- **不変性 (Immutability)**: 構築後のオブジェクトが変更されないことの保証。

### フェーズ 4: 要件システム (30テスト)
- **クラス別ロジック**: アイテム、液体、エネルギー、マナ、ガス、エッセンシア、Vis の各ロジック。
- **レジストリ**: 動的登録、上書きの安全性、デフォルト値の挙動。

### フェーズ 5: Visitor パターン (20テスト)
- **走査**: 訪問中におけるレイヤーおよび要件の完全なカバー。
- **バリデーション Visitor**: 詳細なエラー収集とレポート。

### フェーズ 6: レジストリ & マネージャー (30テスト)
- **CustomStructureRegistry**: 定義の検索と StructureLib 統合。
- **StructureManager**: シングルトン状態とライフサイクル管理。

### フェーズ 7: シリアライゼーション (15テスト)
- **ラウンドトリップ**: `JSON -> オブジェクト -> JSON` の変換結果が同一であることの確認。

## 2. 優先度マトリクス

- **最優先 (CRITICAL)**: JSON ローダー、未定義シンボル検出、コントローラーオフセット計算。
- **重要 (HIGH)**: Builder バリデーション、要件レジストリ、バリデーション Visitor。
- **中 (MEDIUM)**: レジストリ管理、シリアライゼーション。

## 3. 実装ガイドライン
テストは `src/test/java/ruiseki/omoshiroikamo/api/structure/` に配置されます。レシピシステムのテストパターン (JUnit 5) に従ってください。
